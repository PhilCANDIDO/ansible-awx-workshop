---
# Playbook pour d√©ployer uniquement le serveur web (nginx)
#
# Usage :
#   ansible-playbook -i inventory/hosts.ini deploy_webserver.yml
#
# Avec variables personnalis√©es :
#   ansible-playbook -i inventory/hosts.ini deploy_webserver.yml \
#     -e "nginx_port=8080 nginx_server_name=myapp.local"

- name: D√©ploiement du serveur web Nginx
  hosts: "{{ target_hosts | default('webservers') }}"
  gather_facts: true
  become: true

  pre_tasks:
    - name: Afficher les informations de d√©ploiement
      ansible.builtin.debug:
        msg: 
          - "üåê D√©ploiement de Nginx"
          - ""
          - "Serveur : {{ ansible_hostname }}"
          - "IP : {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
          - "Port HTTP : {{ nginx_port | default(80) }}"
          - "Port HTTPS : {{ nginx_ssl_port | default(443) }}"
          - "SSL activ√© : {{ nginx_enable_ssl | default(true) }}"
      tags:
        - always

    - name: Mettre √† jour le cache des packages
      ansible.builtin.package:
        update_cache: true
      when: ansible_os_family == "Debian"
      tags:
        - always

  roles:
    - webserver

  post_tasks:
    - name: V√©rifier que Nginx est accessible
      ansible.builtin.uri:
        url: "http://localhost:{{ nginx_port | default(80) }}"
        follow_redirects: all
        validate_certs: false
        status_code: 200
      tags:
        - test

    - name: Afficher les URLs d'acc√®s
      ansible.builtin.debug:
        msg: |

          ‚úÖ Nginx d√©ploy√© avec succ√®s !

          URLs d'acc√®s :
          - HTTP : http://{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}:{{ nginx_port | default(80) }}
          {% if nginx_enable_ssl | default(true) %}
          - HTTPS : https://{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}:{{ nginx_ssl_port | default(443) }}
          {% endif %}
          - Health : http://{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}:{{ nginx_port | default(80) }}/health

          Commandes utiles :
          - Status : systemctl status nginx
          - Logs : journalctl -u nginx -f
          - Test config : nginx -t
      tags:
        - always