---
# Playbook pour d√©ployer uniquement la base de donn√©es (MySQL)
#
# Usage :
#   ansible-playbook -i inventory/hosts.ini deploy_database.yml --ask-vault-pass
#
# Avec variables personnalis√©es :
#   ansible-playbook -i inventory/hosts.ini deploy_database.yml --ask-vault-pass \
#     -e "mysql_database=prod_db mysql_user=prod_user"

- name: D√©ploiement de la base de donn√©es MySQL
  hosts: "{{ target_hosts | default('databases') }}"
  gather_facts: true
  become: true

  pre_tasks:
    - name: Afficher les informations de d√©ploiement
      ansible.builtin.debug:
        msg: |
          üóÑÔ∏è D√©ploiement de MySQL

          Serveur : {{ ansible_hostname }}
          IP : {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}
          Port : {{ mysql_port | default(3306) }}
          Base de donn√©es : {{ mysql_database | default('app_db') }}
          Utilisateur : {{ mysql_user | default('app_user') }}
      tags:
        - always

    - name: Mettre √† jour le cache des packages
      ansible.builtin.package:
        update_cache: true
      when: ansible_os_family == "Debian"
      tags:
        - always

  roles:
    - database

  post_tasks:
    - name: Tester la connexion MySQL locale
      community.mysql.mysql_info:
        login_user: "{{ mysql_user }}"
        login_password: "{{ mysql_password }}"
        login_db: "{{ mysql_database }}"
        filter: databases
      register: mysql_test
      ignore_errors: true
      tags:
        - test

    - name: Afficher le r√©sultat du test
      ansible.builtin.debug:
        msg: |

          {% if mysql_test is succeeded %}
          ‚úÖ MySQL d√©ploy√© et test√© avec succ√®s !
          {% else %}
          ‚ö†Ô∏è MySQL d√©ploy√© mais test de connexion √©chou√©
          {% endif %}

          Informations de connexion :
          ---------------------------
          Host : {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}
          Port : {{ mysql_port | default(3306) }}
          Database : {{ mysql_database | default('app_db') }}
          User : {{ mysql_user | default('app_user') }}

          Commande de connexion :
          mysql -h {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }} \
                -P {{ mysql_port | default(3306) }} \
                -u {{ mysql_user | default('app_user') }} \
                -p {{ mysql_database | default('app_db') }}

          Commandes utiles :
          - Status : systemctl status mysql
          - Logs : journalctl -u mysql -f
          - Console root : mysql -u root -p
      tags:
        - always